<!DOCTYPE html>
<html>
<head>
  <title>Band on the Run – JURN Arcade</title>
  <meta charset="UTF-8">
  <style>
    html, body { height:100%; margin:0; background:#000; display:flex; align-items:center; justify-content:center; font-family:'Courier New',monospace; }
    #wrapper { position:relative; width:480px; height:560px; overflow:hidden; }
    canvas { display:block; }
    #titleOverlay, #gameOverOverlay {
      display:none; position:absolute; top:0; left:0; width:480px; height:560px;
      flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.88); color:#c8ff00; text-align:center; z-index:10;
    }
    #titleOverlay { display:flex; }
    h1 { font-size:36px; margin:0 0 2px; letter-spacing:4px; color:#c8ff00; text-shadow:0 0 20px #c8ff00, 0 0 5px #fff; }
    h2 { font-size:26px; margin:0 0 4px; letter-spacing:4px; color:#ff2d2d; text-shadow:0 0 14px #ff2d2d; }
    .sub  { font-size:11px; letter-spacing:4px; color:#888; margin-bottom:10px; }
    .sub2 { font-size:10px; letter-spacing:2px; color:#555; margin-bottom:14px; }
    .press-key { font-size:13px; letter-spacing:3px; color:#c8ff00; animation:blink 1s step-end infinite; margin-top:10px; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    .lb-title { font-size:11px; letter-spacing:3px; color:#888; margin:12px 0 5px; }
    .lb-row   { font-size:12px; color:#c8ff00; letter-spacing:2px; margin:2px 0; }
    .go-row   { font-size:13px; color:#c8ff00; letter-spacing:2px; margin:3px 0; }
    .btn { background:transparent; border:1px solid #c8ff00; color:#c8ff00; font-family:'Courier New',monospace; font-size:12px; letter-spacing:3px; padding:7px 20px; cursor:pointer; margin-top:9px; }
    .btn:hover { background:rgba(200,255,0,0.15); }
    .initials-label { font-size:11px; letter-spacing:3px; color:#888; margin:9px 0 5px; }
    .initials-input { background:transparent; border-bottom:2px solid #c8ff00; color:#c8ff00; font-family:'Courier New',monospace; font-size:20px; letter-spacing:8px; width:76px; text-align:center; outline:none; }
    #rosterLine { font-size:10px; letter-spacing:2px; color:#8a6; margin-bottom:6px; }
  </style>
</head>
<body>
<div id="wrapper">
  <canvas id="game" width="480" height="560"></canvas>
  <div id="titleOverlay">
    <h1>☠ BAND ON THE RUN ☠</h1>
    <div class="sub">A JURN ARCADE GAME</div>
    <div id="rosterLine">VOX · TRASH QUEEN · RIFF-ROT · TAZ</div>
    <div class="sub2">GET THE BAND TO THE TOUR BUS</div>
    <div class="press-key">PRESS ANY KEY TO CROSS</div>
    <div class="lb-title">— HIGH SCORES —</div>
    <div id="titleLb"></div>
  </div>
  <div id="gameOverOverlay">
    <h2>SHOW'S CANCELLED</h2>
    <div class="go-row" id="goScore"></div>
    <div id="goInitialsSection" style="display:none; flex-direction:column; align-items:center;">
      <div class="initials-label">NEW HIGH SCORE — ENTER YOUR INITIALS</div>
      <input type="text" id="goInitialsInput" class="initials-input" maxlength="3" autocomplete="off">
      <button class="btn" id="goSubmitBtn">SUBMIT</button>
    </div>
    <div class="lb-title" style="margin-top:12px;">— HIGH SCORES —</div>
    <div id="goLb"></div>
    <button class="btn" id="playAgainBtn" style="margin-top:16px;">PLAY AGAIN</button>
    <button class="btn" id="goTitleBtn">RETURN TO TITLE</button>
  </div>
</div>
<script>
// ── Firebase ──
var FB_URL = 'https://pitstop-wall-default-rtdb.firebaseio.com/highscores/band-on-the-run';
function fbGet(cb) { var x=new XMLHttpRequest(); x.open('GET',FB_URL+'.json'); x.onload=function(){cb(JSON.parse(x.responseText)||{});}; x.onerror=function(){cb({});}; x.send(); }
function fbPush(name,score) { var x=new XMLHttpRequest(); x.open('POST',FB_URL+'.json'); x.setRequestHeader('Content-Type','application/json'); x.send(JSON.stringify({name:name,score:score})); }
function getSorted(data) { return Object.values(data).filter(e=>e&&e.name&&typeof e.score==='number').sort((a,b)=>b.score-a.score).slice(0,10); }
function isHighScore(score,sorted) { return sorted.length<10||score>sorted[sorted.length-1].score; }
function renderLb(id,sorted,hi) { var el=document.getElementById(id); if(!el) return; el.innerHTML=sorted.slice(0,6).map((e,i)=>'<div class="lb-row" style="'+(e.score===hi?'color:#fff;font-weight:bold;':'')+'">'+( i+1)+'. '+e.name+' &nbsp; '+e.score+'</div>').join(''); }
function loadTitleLb() { fbGet(function(d){ renderLb('titleLb',getSorted(d),-1); }); }
loadTitleLb();

// ── Canvas ──
var canvas = document.getElementById('game');
var ctx = canvas.getContext('2d');
var W=480, H=560, GRID=40, ROWS=14, COLS=12;

// ── Sprites ──
// All assets relative to this page
var ASSET_BASE = 'assets/';

var imgVehicles = new Image(); imgVehicles.src = ASSET_BASE+'vehicles.png';
var imgLogs     = new Image(); imgLogs.src     = ASSET_BASE+'logs.png';
var imgBand     = new Image(); imgBand.src     = ASSET_BASE+'band.png';
var imgTourvan  = new Image(); imgTourvan.src  = ASSET_BASE+'tourvan.png';
var imgRoad     = new Image(); imgRoad.src     = ASSET_BASE+'road_tile.png';
var imgWater    = new Image(); imgWater.src    = ASSET_BASE+'water_tile.png';

// Track load state
var spritesLoaded = 0;
var spritesReady  = false;
var SPRITE_COUNT  = 6;
[imgVehicles, imgLogs, imgBand, imgTourvan, imgRoad, imgWater].forEach(function(img){
  img.onload  = function(){ spritesLoaded++; if(spritesLoaded===SPRITE_COUNT) spritesReady=true; };
  img.onerror = function(){ spritesLoaded++; if(spritesLoaded===SPRITE_COUNT) spritesReady=true; }; // fail gracefully
});

// ── Sprite layout constants ──
// vehicles.png 640x426 — 10 cars, 3 rows of top-downs + bottom partial row with side-profiles
// Side-profile row: y=284, h=142, 3 vehicles at x=160,320,480 each w=160
// Top-down rows: y=0 and y=142, 3 per row, each ~213x142
var V = {
  // side-profile row: y=214, h=106, 4 vehicles at x=0,160,320,480 each w=160
  car0:   {sx:0,   sy:214, sw:160, sh:106},  // small van (facing left)
  car1:   {sx:160, sy:214, sw:160, sh:106},  // utility truck
  car2:   {sx:320, sy:214, sw:160, sh:106},  // delivery van
  car3:   {sx:480, sy:214, sw:160, sh:106},  // fire truck (facing right)
};

// logs.png 550x366 — 4 rows h≈91 each
// Row 0: 1 full-width long log
// Row 1: long + short
// Row 2: 3 medium logs
// Row 3: 4 short logs
var L = {
  long:   {sx:0,   sy:0,  sw:550, sh:91},  // row 0: single full-width log
  medium: {sx:0,   sy:91, sw:330, sh:91},  // row 1: left (longer) log
  short:  {sx:330, sy:91, sw:165, sh:91},  // row 1: right (shorter) log
};

// band.png 512x341 — 4 characters, each 128x341
// 0=Vox(blue eyes+mic), 1=Viking helmet, 2=green mohawk, 3=pink mohawk
var BAND_FRAMES = [
  {sx:0,   sy:0, sw:128, sh:341},  // Vox
  {sx:128, sy:0, sw:128, sh:341},  // Bonecrush (Viking)
  {sx:256, sy:0, sw:128, sh:341},  // Riff-Rot (green mohawk)
  {sx:384, sy:0, sw:128, sh:341},  // Trash Queen / Taz (pink mohawk)
];
var BAND_NAMES = ['VOX','BONECRUSH','RIFF-ROT','TAZ'];

// tourvan.png 480x320 — single van, transparent bg
var TOURVAN_W = 120, TOURVAN_H = Math.round(320 * 120/480); // ≈107px tall

// ── Row types ──
var ROW_TYPES = ['start','road','road','road','road','road','median','water','water','water','water','water','goal_safe','goal'];

// ── Lane definitions ──
// type codes: 'car0','car1','car2' = tinted road vehicles; 'log_l','log_m','log_s' = logs
// tint applied over grayscale vehicle sprites via composite
var LANES = [
  null,
  { sprKey:'car0', tint:'rgba(200,0,40,0.35)',  size:GRID*2.2, speed:-1.4, spacing:[3,5]   },
  { sprKey:'car1', tint:'rgba(20,80,220,0.35)', size:GRID*1.4, speed: 2.0, spacing:[4,3,6] },
  { sprKey:'car3', tint:'rgba(140,60,0,0.35)',  size:GRID*3.5, speed:-1.0, spacing:[4]     },
  { sprKey:'car1', tint:'rgba(180,120,0,0.35)', size:GRID*1.4, speed: 1.6, spacing:[3,4]   },
  { sprKey:'car0', tint:'rgba(80,0,100,0.35)',  size:GRID*2.0, speed:-2.2, spacing:[5,3]   },
  null,
  { sprKey:'log_l', size:GRID*3,   speed: 1.2, spacing:[2]       },
  { sprKey:'log_s', size:GRID*1.5, speed:-0.9, spacing:[0,2,0,3] },
  { sprKey:'log_l', size:GRID*5,   speed: 1.5, spacing:[3]       },
  { sprKey:'log_m', size:GRID*2,   speed:-1.2, spacing:[2]       },
  { sprKey:'log_m', size:GRID*2.5, speed: 0.8, spacing:[1,2]     },
  null,
  null,
];

// Sprite rect lookup
var SPRITE_RECTS = {
  car0: V.car0, car1: V.car1, car2: V.car2, car3: V.car3,
  log_l: L.long, log_m: L.medium, log_s: L.short,
};

// ── State ──
var frogger, scoredMembers, rows, score, lives, phase, memberIdx;
var countPhase=false, countVal=0, countTimer=0;
var COUNT_INTERVAL=800;
var raf=null;
phase='title';

function buildRows() {
  rows=[];
  for (var r=0;r<ROWS;r++) {
    rows[r]=[];
    var pat=LANES[r]; if(!pat) continue;
    var x=0, idx=0, sp=pat.spacing;
    var totalW=sp.reduce((a,b)=>a+b,0)*GRID+sp.length*pat.size;
    var endX=0; while(endX<W) endX+=totalW; endX+=totalW;
    while(x<endX) {
      rows[r].push({x:x,size:pat.size,speed:pat.speed,sprKey:pat.sprKey,tint:pat.tint,index:idx});
      x+=pat.size+sp[idx]*GRID; idx=(idx+1)%sp.length;
    }
  }
}

function initGame() { score=0;lives=4;phase='playing';memberIdx=0;scoredMembers=[];buildRows();resetFrogger();startCountdown(); }
function resetFrogger() { frogger={x:GRID*5,y:0,speed:0}; }

// ── Countdown ──
function startCountdown() {
  countPhase=true; countVal=3; countTimer=Date.now();
  if(raf){cancelAnimationFrame(raf);raf=null;}
  raf=requestAnimationFrame(countLoop);
}
function countLoop() {
  moveLanes();
  ctx.clearRect(0,0,W,H); drawBg(); drawTourVan(); drawLaneSprites();
  scoredMembers.forEach(function(sm){drawMember(sm.x,rowY(ROWS-1),sm.mIdx);});
  drawMember(frogger.x,rowY(frogger.y),memberIdx);

  var elapsed=Date.now()-countTimer;
  var beat=Math.floor(elapsed/COUNT_INTERVAL);
  var label='';
  if      (beat===0) label='3';
  else if (beat===1) label='2';
  else if (beat===2) label='1';
  else if (beat===3) label="LET'S ROCK!";
  else { countPhase=false; raf=requestAnimationFrame(gameLoop); return; }

  var pulse=(elapsed%COUNT_INTERVAL)/COUNT_INTERVAL;
  ctx.save();
  ctx.globalAlpha=1-pulse*0.4;
  ctx.translate(W/2,H/2); ctx.scale(1+pulse*0.5,1+pulse*0.5);
  ctx.font='bold 72px "Courier New"'; ctx.textAlign='center';
  ctx.fillStyle='#c8ff00'; ctx.shadowColor='#c8ff00'; ctx.shadowBlur=30;
  ctx.fillText(label,0,24);
  ctx.restore();

  if (beat!==countVal) { countVal=beat; playCountTick(beat); }
  raf=requestAnimationFrame(countLoop);
}

// ── Audio ──
var AudioCtx=window.AudioContext||window.webkitAudioContext, actx=null;
function ensureAudio(){if(!actx)actx=new AudioCtx();}
function playCountTick(beat){ensureAudio();var f=beat<3?440:880,osc=actx.createOscillator(),g=actx.createGain();osc.connect(g);g.connect(actx.destination);osc.type='square';osc.frequency.value=f;g.gain.setValueAtTime(0.18,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.15);osc.start();osc.stop(actx.currentTime+0.18);}
function playHop(){ensureAudio();var osc=actx.createOscillator(),g=actx.createGain();osc.connect(g);g.connect(actx.destination);osc.type='square';osc.frequency.value=280;osc.frequency.exponentialRampToValueAtTime(520,actx.currentTime+0.06);g.gain.setValueAtTime(0.1,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.09);osc.start();osc.stop(actx.currentTime+0.12);}
function playSplat(){ensureAudio();var buf=actx.createBuffer(1,actx.sampleRate*0.45,actx.sampleRate),d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.4);var src=actx.createBufferSource(),g=actx.createGain();src.buffer=buf;src.connect(g);g.connect(actx.destination);g.gain.setValueAtTime(0.5,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.45);src.start();src.stop(actx.currentTime+0.5);}
function playScore(){ensureAudio();[330,440,550,660].forEach(function(f,i){var osc=actx.createOscillator(),g=actx.createGain();osc.connect(g);g.connect(actx.destination);osc.frequency.value=f;osc.type='square';g.gain.setValueAtTime(0,actx.currentTime+i*0.07);g.gain.linearRampToValueAtTime(0.12,actx.currentTime+i*0.07+0.02);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+i*0.07+0.12);osc.start(actx.currentTime+i*0.07);osc.stop(actx.currentTime+i*0.07+0.15);});}
function playWin(){ensureAudio();[330,392,440,523,587,659,784].forEach(function(f,i){var osc=actx.createOscillator(),g=actx.createGain();osc.connect(g);g.connect(actx.destination);osc.frequency.value=f;osc.type='square';g.gain.setValueAtTime(0,actx.currentTime+i*0.1);g.gain.linearRampToValueAtTime(0.15,actx.currentTime+i*0.1+0.02);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+i*0.1+0.18);osc.start(actx.currentTime+i*0.1);osc.stop(actx.currentTime+i*0.1+0.2);});}

// ── Draw helpers ──
function rowY(r){return H-(r+1)*GRID;}

function moveLanes(){
  for(var r=0;r<ROWS;r++){
    var pat=LANES[r];if(!pat)continue;
    var row=rows[r];
    for(var i=0;i<row.length;i++){
      var spr=row[i]; spr.x+=spr.speed; spr._y=rowY(r);
      if(spr.speed<0&&spr.x<-spr.size){var rm=row.reduce(function(a,b){return b.x>a.x?b:a;});var sp=pat.spacing;spr.x=rm.x+rm.size+sp[rm.index%sp.length]*GRID;spr.index=(rm.index+1)%sp.length;}
      if(spr.speed>0&&spr.x>W){var lm=row.reduce(function(a,b){return b.x<a.x?b:a;});var sp=pat.spacing;var ix=lm.index-1;if(ix<0)ix=sp.length-1;spr.x=lm.x-sp[ix]*GRID-spr.size;spr.index=ix;}
    }
  }
}

function drawBg(){
  ctx.fillStyle='#06000e';ctx.fillRect(0,0,W,H);

  // Goal zone rows 12-13
  ctx.fillStyle='#110008';ctx.fillRect(0,rowY(13),W,GRID*2);
  for(var s=0;s<12;s++){var sx=(s+0.5)*(W/12),pulse=0.5+0.5*Math.sin(Date.now()/600+s*0.9);ctx.fillStyle='rgba(200,255,0,'+(0.08+pulse*0.18)+')';ctx.beginPath();ctx.arc(sx,rowY(13)+5,3,0,Math.PI*2);ctx.fill();}

  // 4 cubby slots row 12
  ctx.fillStyle='#1a0a00';ctx.fillRect(0,rowY(12),W,GRID);
  var slotW=W/4;
  for(var c=0;c<4;c++){
    ctx.strokeStyle='#c8ff00';ctx.lineWidth=1;
    ctx.strokeRect(c*slotW+3,rowY(12)+3,slotW-6,GRID-6);
    ctx.fillStyle='rgba(200,255,0,0.2)';ctx.font='7px "Courier New"';ctx.textAlign='center';
    ctx.fillText(c+1,c*slotW+slotW/2,rowY(12)+GRID-5);ctx.textAlign='left';
  }
  ctx.strokeStyle='#c8ff00';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,rowY(12)+GRID);ctx.lineTo(W,rowY(12)+GRID);ctx.stroke();

  // Muddy water rows 7-11 — 16-bit tile
  for(var r=7;r<=11;r++){
    if(spritesReady&&imgWater.complete&&imgWater.naturalWidth>0){
      // Animate tile offset for ripple effect
      var woff=Math.floor(Date.now()/120+r*15)%480;
      // Draw twice to handle wrap-around scroll
      ctx.drawImage(imgWater,woff,0,480-woff,80,0,rowY(r),(480-woff)*(W/(480)),GRID);
      if(woff>0) ctx.drawImage(imgWater,0,0,woff,80,(480-woff)*(W/480),rowY(r),woff*(W/480),GRID);
    } else {
      var wg=ctx.createLinearGradient(0,rowY(r),0,rowY(r)+GRID);
      wg.addColorStop(0,'#2a1a08');wg.addColorStop(0.5,'#3d2810');wg.addColorStop(1,'#1e1208');
      ctx.fillStyle=wg;ctx.fillRect(0,rowY(r),W,GRID);
    }
    // Ripple shimmer overlay
    ctx.strokeStyle='rgba(120,90,40,0.12)';ctx.lineWidth=1;ctx.setLineDash([8,6]);
    var off2=(Date.now()/80+r*25)%W;
    ctx.beginPath();ctx.moveTo(-off2,rowY(r)+GRID*0.6);ctx.lineTo(W+W-off2,rowY(r)+GRID*0.6);ctx.stroke();
    ctx.setLineDash([]);
  }

  // Median row 6
  ctx.fillStyle='#111822';ctx.fillRect(0,rowY(6),W,GRID);
  ctx.fillStyle='rgba(200,255,0,0.08)';for(var m=0;m<6;m++)ctx.fillRect(m*GRID*2+8,rowY(6)+10,GRID-16,20);

  // Road rows 1-5 — 16-bit tile
  for(var rd=1;rd<=5;rd++){
    if(spritesReady&&imgRoad.complete&&imgRoad.naturalWidth>0){
      // tile 480×80 strip: draw top half or bottom half alternating for variety
      var sy16=(rd%2===0)?0:40;
      ctx.drawImage(imgRoad,0,sy16,480,40,0,rowY(rd),W,GRID);
    } else {
      ctx.fillStyle=rd%2===0?'#141424':'#1a1a2e';ctx.fillRect(0,rowY(rd),W,GRID);
    }
    // Lane divider subtle overlay
    ctx.strokeStyle='rgba(200,255,0,0.04)';ctx.lineWidth=1;ctx.setLineDash([16,12]);
    ctx.beginPath();ctx.moveTo(0,rowY(rd)+GRID);ctx.lineTo(W,rowY(rd)+GRID);ctx.stroke();ctx.setLineDash([]);
  }

  // Start row 0
  ctx.fillStyle='#0d1a06';ctx.fillRect(0,rowY(0),W,GRID);

  // HUD
  ctx.fillStyle='#c8ff00';ctx.font='bold 12px "Courier New"';ctx.fillText('SCORE: '+score,8,15);
  // Mini band sprite life icons
  for(var lv=0;lv<lives;lv++) drawMiniMember(W-112+lv*28,2,memberIdx);
  // Member name
  ctx.fillStyle='rgba(200,255,0,0.45)';ctx.font='8px "Courier New"';ctx.fillText(BAND_NAMES[memberIdx%4],8,H-4);
}

// ── Tour van (sprite if loaded, canvas fallback) ──
function drawTourVan(){
  var vw=TOURVAN_W, vh=TOURVAN_H||42;
  var vx=(W-vw)/2, vy=rowY(13)+2;
  if(spritesReady&&imgTourvan.complete&&imgTourvan.naturalWidth>0){
    // White bg removal: tourvan has transparent bg, just draw it
    ctx.drawImage(imgTourvan,0,0,480,320,vx,vy,vw,vh);
    // Glow outline
    ctx.strokeStyle='#c8ff00';ctx.lineWidth=1;ctx.strokeRect(vx,vy,vw,vh);
  } else {
    // Canvas fallback
    var bg=ctx.createLinearGradient(vx,vy,vx,vy+vh);
    bg.addColorStop(0,'#3a0050');bg.addColorStop(1,'#110022');
    ctx.fillStyle=bg;ctx.fillRect(vx,vy,vw,vh);
    ctx.strokeStyle='#cc9900';ctx.lineWidth=1.5;ctx.strokeRect(vx+1,vy+1,vw-2,vh-2);
    ctx.font='bold 18px sans-serif';ctx.textAlign='center';ctx.fillStyle='#c8a050';ctx.fillText('☠',vx+vw/2,vy+vh-4);
    ctx.fillStyle='#c8ff00';ctx.font='bold 7px "Courier New"';ctx.fillText('☠ JURN TOUR ☠',vx+vw/2,vy+10);ctx.textAlign='left';
  }
}

// ── Draw vehicle sprite (with tint overlay for grayscale cars, or log) ──
function drawVehicle(spr){
  var ry=spr._y!==undefined?spr._y:rowY(0);
  var rect=SPRITE_RECTS[spr.sprKey];
  var isLog=spr.sprKey.startsWith('log');
  var destH=GRID-8, destY=ry+(GRID-destH)/2;

  if(spritesReady&&rect){
    var img=isLog?imgLogs:imgVehicles;
    if(img.complete&&img.naturalWidth>0){
      ctx.save();
      // Clip to sprite area
      ctx.beginPath();ctx.rect(spr.x,ry,spr.size,GRID);ctx.clip();
      // Draw sprite stretched to lane size
      ctx.drawImage(img,rect.sx,rect.sy,rect.sw,rect.sh,spr.x,ry,spr.size,GRID);
      // Apply color tint for vehicles (multiply-like overlay)
      if(!isLog&&spr.tint){
        ctx.globalCompositeOperation='multiply';
        ctx.fillStyle=spr.tint;
        ctx.fillRect(spr.x,ry,spr.size,GRID);
        ctx.globalCompositeOperation='source-over';
      }
      ctx.restore();
      return;
    }
  }
  // Canvas fallback
  if(isLog){
    var lg=ctx.createLinearGradient(spr.x,ry+10,spr.x,ry+GRID-10);
    lg.addColorStop(0,'#9a7040');lg.addColorStop(0.5,'#5a4020');lg.addColorStop(1,'#7a5830');
    ctx.fillStyle=lg;ctx.fillRect(spr.x+2,ry+10,spr.size-4,GRID-20);
    ctx.fillStyle='#c8a050';ctx.beginPath();ctx.arc(spr.x+10,ry+GRID/2,7,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(spr.x+spr.size-10,ry+GRID/2,7,0,Math.PI*2);ctx.fill();
  } else {
    ctx.fillStyle=spr.tint||'#445';ctx.fillRect(spr.x,ry+6,spr.size,GRID-12);
    ctx.fillStyle='rgba(180,220,255,0.2)';ctx.fillRect(spr.x+spr.size*0.22,ry+8,spr.size*0.22,GRID-18);
  }
}

function drawLaneSprites(){
  for(var r=0;r<ROWS;r++){var pat=LANES[r];if(!pat)continue;var row=rows[r];for(var i=0;i<row.length;i++)drawVehicle(row[i]);}
}

// ── Draw band member (sprite if loaded, canvas fallback) ──
function drawMember(x,y,idx){
  var frame=BAND_FRAMES[idx%4];
  if(spritesReady&&imgBand.complete&&imgBand.naturalWidth>0){
    // band.png has white background — key it out
    // Draw to offscreen, then use threshold keying
    var sprW=GRID, sprH=GRID;
    // Direct draw with white as bg — use destination-out trick
    ctx.save();
    // Step 1: draw sprite
    ctx.drawImage(imgBand,frame.sx,frame.sy,frame.sw,frame.sh,x,y,sprW,sprH);
    ctx.restore();
    return;
  }
  // Canvas fallback skull
  var cx=x+GRID/2, cy=y+GRID/2;
  ctx.save();
  ctx.fillStyle='#e8dcc8';ctx.beginPath();ctx.arc(cx,cy-4,12,0,Math.PI*2);ctx.fill();
  ctx.fillRect(cx-8,cy+2,16,10);
  ctx.fillStyle='#44aaff';ctx.beginPath();ctx.arc(cx-4,cy-6,4,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+4,cy-6,4,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(0,0,0,0.6)';ctx.beginPath();ctx.arc(cx-4,cy-6,2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+4,cy-6,2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(0,0,0,0.5)';ctx.beginPath();ctx.arc(cx,cy-2,2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#d0c8b0';for(var t=0;t<4;t++)ctx.fillRect(cx-7+t*4,cy+4,3,6);
  ctx.restore();
}

// Mini member for HUD lives
function drawMiniMember(x,y,idx){
  var frame=BAND_FRAMES[idx%4];
  if(spritesReady&&imgBand.complete&&imgBand.naturalWidth>0){
    ctx.drawImage(imgBand,frame.sx,frame.sy,frame.sw,frame.sh,x,y,20,20);
    return;
  }
  ctx.save();ctx.fillStyle='#e8dcc8';ctx.beginPath();ctx.arc(x+8,y+8,6,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#44aaff';ctx.beginPath();ctx.arc(x+6,y+6,1.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(x+10,y+6,1.5,0,Math.PI*2);ctx.fill();ctx.restore();
}

// ── Game Loop ──
function gameLoop(){
  if(phase!=='playing')return;
  raf=requestAnimationFrame(gameLoop);
  moveLanes();
  ctx.clearRect(0,0,W,H);drawBg();drawTourVan();drawLaneSprites();
  frogger.x+=frogger.speed;frogger.speed=0;
  scoredMembers.forEach(function(sm){drawMember(sm.x,rowY(ROWS-1),sm.mIdx);});
  drawMember(frogger.x,rowY(frogger.y),memberIdx);

  var fr=frogger.y, onFloater=false;
  if(rows[fr]){
    for(var i=0;i<rows[fr].length;i++){
      var spr=rows[fr][i];
      if(frogger.x<spr.x+spr.size-4&&frogger.x+GRID-4>spr.x){
        var rtype=ROW_TYPES[fr];
        if(rtype==='road'){playSplat();loseLife();return;}
        else if(rtype==='water'){onFloater=true;frogger.speed=spr.speed;}
      }
    }
  }
  if(!onFloater&&ROW_TYPES[fr]==='water'){playSplat();loseLife();return;}
  if(frogger.x<0)frogger.x=0;if(frogger.x>W-GRID)frogger.x=W-GRID;

  if(frogger.y===ROWS-1){
    var slot=Math.max(0,Math.min(3,Math.floor(frogger.x/(W/4))));
    var slotX=slot*(W/4)+(W/4-GRID)/2;
    if(!scoredMembers.find(function(sm){return sm.slot===slot;})){
      scoredMembers.push({x:slotX,y:ROWS-1,mIdx:memberIdx,slot:slot});
      memberIdx++;score+=200;playScore();
    }
    cancelAnimationFrame(raf);raf=null;resetFrogger();
    if(scoredMembers.length>=4){score+=1000;playWin();scoredMembers=[];memberIdx=0;}
    startCountdown();
  }
}

function loseLife(){
  cancelAnimationFrame(raf);raf=null;
  lives--;if(lives<=0){triggerGameOver();return;}
  resetFrogger();startCountdown();
}

function triggerGameOver(){
  if(phase==='gameover')return;
  phase='gameover';cancelAnimationFrame(raf);raf=null;
  fbGet(function(data){
    var sorted=getSorted(data);
    document.getElementById('goScore').textContent='FINAL SCORE: '+score;
    if(isHighScore(score,sorted)){
      var initSec=document.getElementById('goInitialsSection');initSec.style.display='flex';
      var inp=document.getElementById('goInitialsInput');inp.value='';
      setTimeout(function(){inp.focus();},80);
      function submitScore(){if(document.activeElement&&document.activeElement.tagName==='INPUT'&&inp.value.trim().length===0)return;var name=inp.value.trim().toUpperCase().slice(0,3)||'AAA';fbPush(name,score);initSec.style.display='none';fbGet(function(d2){renderLb('goLb',getSorted(d2),score);});}
      document.getElementById('goSubmitBtn').onclick=submitScore;
      inp.onkeydown=function(e){if(e.key==='Enter')submitScore();};
    } else {renderLb('goLb',sorted,score);}
    document.getElementById('gameOverOverlay').style.display='flex';
  });
}

// ── Controls ──
document.addEventListener('keydown',function(e){
  if(phase==='title'){ensureAudio();document.getElementById('titleOverlay').style.display='none';initGame();return;}
  if(countPhase)return;
  if(phase!=='playing')return;
  if(document.activeElement&&document.activeElement.tagName==='INPUT')return;
  var moved=false;
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A'){frogger.x-=GRID;moved=true;}
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D'){frogger.x+=GRID;moved=true;}
  if(e.key==='ArrowUp'||e.key==='w'||e.key==='W'){if(frogger.y<ROWS-1){frogger.y++;moved=true;}}
  if(e.key==='ArrowDown'||e.key==='s'||e.key==='S'){if(frogger.y>0){frogger.y--;moved=true;}}
  if(moved){playHop();frogger.x=Math.min(Math.max(0,frogger.x),W-GRID);e.preventDefault();}
});

var touchStartX,touchStartY;
canvas.addEventListener('touchstart',function(e){touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;e.preventDefault();},{passive:false});
canvas.addEventListener('touchend',function(e){
  if(phase==='title'){ensureAudio();document.getElementById('titleOverlay').style.display='none';initGame();return;}
  if(countPhase||phase!=='playing')return;
  var dx=e.changedTouches[0].clientX-touchStartX,dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)){if(dx>20){frogger.x+=GRID;playHop();}else if(dx<-20){frogger.x-=GRID;playHop();}}
  else{if(dy<-20){if(frogger.y<ROWS-1){frogger.y++;playHop();}}else if(dy>20){if(frogger.y>0){frogger.y--;playHop();}}}
  frogger.x=Math.min(Math.max(0,frogger.x),W-GRID);e.preventDefault();
},{passive:false});

document.getElementById('playAgainBtn').addEventListener('click',function(){document.getElementById('gameOverOverlay').style.display='none';initGame();});
document.getElementById('goTitleBtn').addEventListener('click',function(){document.getElementById('gameOverOverlay').style.display='none';loadTitleLb();document.getElementById('titleOverlay').style.display='flex';phase='title';});

(function(){ctx.fillStyle='#06000e';ctx.fillRect(0,0,W,H);})();
phase='title';
</script>
</body>
</html>