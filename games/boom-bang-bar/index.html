<!DOCTYPE html>
<html>
<head>
  <title>The Bang Boom Bar &#8211; JURN Arcade</title>
  <meta charset="UTF-8">
  <style>
    html, body { height:100%; margin:0; background:#1a0800; display:flex; align-items:center; justify-content:center; flex-direction:column; font-family:'Courier New',monospace; }
    canvas { cursor:crosshair; display:block; }
    #titleOverlay, #modeSelectOverlay, #gameOverOverlay, #countdownOverlay, #waveOverlay {
      display:none; position:absolute; top:0; left:0; width:640px; height:480px;
      flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.88); color:#ff6600; text-align:center; z-index:10;
    }
    #titleOverlay { display:flex; }
    h1 { font-size:36px; margin:0 0 2px 0; letter-spacing:3px; color:#ff6600; text-shadow: 0 0 24px #ff6600, 0 0 6px #fff; }
    h2 { font-size:28px; margin:0 0 4px 0; letter-spacing:4px; color:#ff2d2d; text-shadow: 0 0 16px #ff2d2d; }
    .sub { font-size:12px; letter-spacing:4px; color:#888; margin-bottom:12px; }
    .press-key { font-size:14px; letter-spacing:3px; color:#ff6600; animation: blink 1s step-end infinite; margin-top:12px; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    .lb-title { font-size:12px; letter-spacing:3px; color:#888; margin:14px 0 6px; }
    .lb-row { font-size:13px; color:#ff6600; letter-spacing:2px; margin:2px 0; }
    .go-row { font-size:14px; color:#ff6600; letter-spacing:2px; margin:3px 0; }
    .btn { background:transparent; border:1px solid #ff6600; color:#ff6600; font-family:'Courier New',monospace; font-size:13px; letter-spacing:3px; padding:8px 22px; cursor:pointer; margin-top:10px; }
    .btn:hover { background:rgba(255,102,0,0.15); }
    .initials-label { font-size:12px; letter-spacing:3px; color:#888; margin:10px 0 6px; }
    .initials-input { background:transparent; border-bottom:2px solid #ff6600; color:#ff6600; font-family:'Courier New',monospace; font-size:22px; letter-spacing:8px; width:80px; text-align:center; outline:none; }
    #wrapper { position:relative; width:640px; height:480px; overflow:hidden; }

    /* Mode select */
    .mode-btn { background:transparent; border:2px solid #ff6600; color:#ff6600; font-family:'Courier New',monospace;
      font-size:16px; letter-spacing:3px; padding:14px 36px; cursor:pointer; margin:8px 0; width:340px;
      text-align:left; transition:background 0.1s; }
    .mode-btn:hover { background:rgba(255,102,0,0.18); }
    .mode-btn .mode-desc { font-size:10px; letter-spacing:2px; color:#888; display:block; margin-top:4px; }
    .mode-btn.chaos { border-color:#ff2d2d; color:#ff2d2d; }
    .mode-btn.chaos:hover { background:rgba(255,45,45,0.18); }
    .mode-btn.highscore { border-color:#ffcc00; color:#ffcc00; }
    .mode-btn.highscore:hover { background:rgba(255,204,0,0.18); }

    /* Countdown overlay */
    #countdownOverlay { background:rgba(0,0,0,0.7); z-index:20; }
    #countdownText { font-size:96px; color:#ff6600; text-shadow:0 0 40px #ff6600, 0 0 10px #fff;
      font-family:'Courier New',monospace; font-weight:bold; letter-spacing:4px; }

    /* Wave clear overlay */
    #waveOverlay { background:rgba(0,0,0,0.72); z-index:15; }
    #waveClearText { font-size:32px; color:#c8ff00; text-shadow:0 0 20px #c8ff00; letter-spacing:4px; margin-bottom:8px; }
    #waveSubText  { font-size:14px; color:#888; letter-spacing:3px; }
  </style>
</head>
<body>
<div id="wrapper">
  <video id="bgVideo" width="640" height="480" muted loop playsinline
    style="position:absolute;top:0;left:0;z-index:0;display:none;object-fit:cover;pointer-events:none;"
    src="assets/bgvideo.mp4">
  </video>
  <canvas id="game" width="640" height="480" style="position:relative;z-index:1;background:transparent;"></canvas>

  <!-- TITLE OVERLAY -->
  <div id="titleOverlay">
    <canvas id="titleCard" width="320" height="110" style="margin-bottom:8px;border:1px solid #ff6600;"></canvas>
    <h1>THE BANG BOOM BAR</h1>
    <div class="sub">A JURN ARCADE GAME</div>
    <div class="press-key">CLICK TO BEGIN</div>
    <div class="lb-title">&#8212; HIGH SCORES &#8212;</div>
    <div id="titleLb"></div>
  </div>

  <!-- MODE SELECT OVERLAY -->
  <div id="modeSelectOverlay">
    <h1 style="font-size:22px;margin-bottom:4px;">SELECT MODE</h1>
    <div class="sub" style="margin-bottom:18px;">CHOOSE YOUR FATE</div>
    <button class="mode-btn" id="btnTraining">
      TRAINING MODE
      <span class="mode-desc">6 WAVES &bull; INFINITE AMMO &bull; AMPS RESET &bull; LEARN THE BAR</span>
    </button>
    <button class="mode-btn highscore" id="btnHighscore">
      HIGH SCORE MODE
      <span class="mode-desc">ENDLESS SURVIVAL &bull; LIMITED AMMO &bull; ONE LIFE &bull; LEADERBOARD</span>
    </button>
    <button class="mode-btn chaos" id="btnChaos">
      CHAOS MODE
      <span class="mode-desc">INFINITE AMMO &bull; ENDLESS WAVES &bull; NO RULES &bull; PURE MAYHEM</span>
    </button>
    <button class="btn" id="btnModeBack" style="margin-top:18px;font-size:11px;padding:6px 16px;">&#8592; BACK</button>
  </div>

  <!-- COUNTDOWN OVERLAY -->
  <div id="countdownOverlay">
    <div id="countdownText"></div>
  </div>

  <!-- WAVE CLEAR OVERLAY (Training only) -->
  <div id="waveOverlay">
    <div id="waveClearText"></div>
    <div id="waveSubText"></div>
  </div>

  <!-- GAME OVER OVERLAY -->
  <div id="gameOverOverlay">
    <h2>GAME OVER</h2>
    <div class="go-row" id="goScore"></div>
    <div id="goModeLabel" style="font-size:11px;letter-spacing:3px;color:#888;margin:4px 0;"></div>
    <div id="goInitialsSection" style="display:none; flex-direction:column; align-items:center;">
      <div class="initials-label">NEW HIGH SCORE &#8212; ENTER YOUR INITIALS</div>
      <input type="text" id="goInitialsInput" class="initials-input" maxlength="3" autocomplete="off">
      <button class="btn" id="goSubmitBtn">SUBMIT</button>
    </div>
    <div class="lb-title" style="margin-top:14px;">&#8212; HIGH SCORES &#8212;</div>
    <div id="goLb"></div>
    <button class="btn" id="playAgainBtn" style="margin-top:10px;">PLAY AGAIN</button>
    <button class="btn" id="titleBtn">TITLE</button>
  </div>
</div>

<audio id="bgAudio" loop src="assets/chiprage.mp3" style="display:none;"></audio>

<script>
// ─── FIREBASE ─────────────────────────────────────────────────────────────────
var FB_URL='https://pitstop-wall-default-rtdb.firebaseio.com/highscores/the-bang-boom-bar';
function fbGet(cb){var x=new XMLHttpRequest();x.open('GET',FB_URL+'.json');x.onload=function(){cb(JSON.parse(x.responseText)||{});};x.onerror=function(){cb({});};x.send();}
function fbPush(n,s){var x=new XMLHttpRequest();x.open('POST',FB_URL+'.json');x.setRequestHeader('Content-Type','application/json');x.send(JSON.stringify({name:n,score:s}));}
function getSorted(d){return Object.values(d).filter(function(e){return e&&e.name&&typeof e.score==='number';}).sort(function(a,b){return b.score-a.score;}).slice(0,10);}
function isHighScore(s,sorted){return sorted.length<10||s>sorted[sorted.length-1].score;}
function renderLb(id,sorted,hi){var el=document.getElementById(id);if(!el)return;el.innerHTML=sorted.slice(0,7).map(function(e,i){var st=(e.score===hi)?'color:#fff;font-weight:bold;':'';return '<div class="lb-row" style="'+st+'">'+(i+1)+'. '+e.name+'  '+e.score+'</div>';}).join('');}
function loadTitleLb(){fbGet(function(d){renderLb('titleLb',getSorted(d),-1);});}
loadTitleLb();

var canvas=document.getElementById('game');
var ctx=canvas.getContext('2d');
var W=canvas.width,H=canvas.height;

var CROWD_TOP=32, CROWD_BOT=220;
var STAGE_TOP=255, STAGE_BOT=440;
var BAND_Y=375;
var AMP_Y=460;
var AMP_W=40, AMP_H=30;
var NOTE_SPD=11, MAX_LVL=6;

var BAND_SPRITES=[
  {sx:92,  sy:193, sw:197, sh:209, name:'guitarist_pink'},
  {sx:348, sy:205, sw:133, sh:194, name:'vocalist'},
  {sx:518, sy:201, sw:208, sh:233, name:'drummer'},
  {sx:726, sy:201, sw:208, sh:233, name:'guitarist_green'}
];
var BAND_DRAW_H=60;
var BAND_XS=[145, 265, 385, 505];

var THROW_NAMES=['ashtray','baseball1','bottle1','bottle2','bottle3','duck','hand','star1'];
var throwImgs=THROW_NAMES.map(function(n){
  var img=new Image(); img.src='assets/'+n+'.png'; return img;
});
var smokeImg=new Image(); var smokeReady=false;
smokeImg.onload=function(){smokeReady=true;};
smokeImg.src='assets/Smokeboom.png';

var AMP_POS=[65,160,255,440,545,610];
var C={accent:'#ff6600',note:'#c8ff00',red:'#ff2d2d',bone:'#e8dcc8',dark:'#1a0a00',dim:'#555'};

// ─── IMAGES ───────────────────────────────────────────────────────────────────
var bandImg=new Image();
var bandReady=false;
var ampImg=new Image(), ampReady=false;
var dampImg=new Image(), dampReady=false;
bandImg.onload=function(){bandReady=true;};
ampImg.onload=function(){ampReady=true;};
dampImg.onload=function(){dampReady=true;};
bandImg.src='assets/band-sprites.png';
ampImg.src='assets/amp.png';
dampImg.src='assets/destroyedamp.png';

var bgVideo=document.getElementById('bgVideo');
var bgVideoReady=false;
bgVideo.addEventListener('canplay',function(){bgVideoReady=true;bgVideo.play().catch(function(){});});

// ─── AUDIO ────────────────────────────────────────────────────────────────────
var AudioCtx=window.AudioContext||window.webkitAudioContext;
var audioCtx=null;
var guitarBuffers=[null,null,null];

function ensureAudio(){
  if(!audioCtx){
    audioCtx=new AudioCtx();
    ['assets/guitar1.mp3','assets/guitar2.mp3','assets/guitar3.mp3'].forEach(function(url,i){
      fetch(url).then(function(r){return r.arrayBuffer();}).then(function(ab){return audioCtx.decodeAudioData(ab);}).then(function(buf){guitarBuffers[i]=buf;}).catch(function(){});
    });
  }
}

function playFallbackNote(idx){
  if(!audioCtx)return;
  var freq=[196,220,261.6,329.6,392][idx%5];
  var sr=audioCtx.sampleRate, bufLen=Math.round(sr/freq), total=sr*0.9;
  var buf=audioCtx.createBuffer(1,total,sr), data=buf.getChannelData(0);
  for(var i=0;i<bufLen;i++)data[i]=Math.random()*2-1;
  for(var j=bufLen;j<total;j++)data[j]=0.499*(data[j-bufLen]+data[j-bufLen+1]);
  var src=audioCtx.createBufferSource(), gain=audioCtx.createGain();
  src.buffer=buf; src.connect(gain); gain.connect(audioCtx.destination);
  gain.gain.setValueAtTime(0.4,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.9);
  src.start(); src.stop(audioCtx.currentTime+1.0);
}

function playGuitarSound(idx){
  if(!audioCtx)return;
  var buf=guitarBuffers[idx%3];
  if(!buf){playFallbackNote(idx);return;}
  var src=audioCtx.createBufferSource(), gain=audioCtx.createGain();
  src.buffer=buf; src.connect(gain); gain.connect(audioCtx.destination);
  gain.gain.setValueAtTime(0.5,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1.5);
  src.start(); src.stop(audioCtx.currentTime+1.6);
}

function playGlassBreak(){
  if(!audioCtx)return;
  var now=audioCtx.currentTime;
  var sr=audioCtx.sampleRate;
  var thudOsc=audioCtx.createOscillator(), thudGain=audioCtx.createGain();
  thudOsc.type='sine';
  thudOsc.frequency.setValueAtTime(160,now);
  thudOsc.frequency.exponentialRampToValueAtTime(30,now+0.08);
  thudGain.gain.setValueAtTime(0.9,now);
  thudGain.gain.exponentialRampToValueAtTime(0.001,now+0.12);
  thudOsc.connect(thudGain); thudGain.connect(audioCtx.destination);
  thudOsc.start(now); thudOsc.stop(now+0.15);
  var crunchLen=Math.round(sr*0.22);
  var crunchBuf=audioCtx.createBuffer(1,crunchLen,sr);
  var cd=crunchBuf.getChannelData(0);
  for(var i=0;i<crunchLen;i++){
    var env=Math.pow(1-i/crunchLen,0.6);
    var raw=(Math.random()*2-1)*env;
    cd[i]=raw>0.4?0.4:(raw<-0.4?-0.4:raw);
  }
  var crunchSrc=audioCtx.createBufferSource();
  var crunchFilt=audioCtx.createBiquadFilter(), crunchGain=audioCtx.createGain();
  crunchFilt.type='bandpass'; crunchFilt.frequency.value=800; crunchFilt.Q.value=0.7;
  crunchSrc.buffer=crunchBuf;
  crunchGain.gain.setValueAtTime(0.65,now+0.01);
  crunchGain.gain.exponentialRampToValueAtTime(0.001,now+0.25);
  crunchSrc.connect(crunchFilt); crunchFilt.connect(crunchGain); crunchGain.connect(audioCtx.destination);
  crunchSrc.start(now+0.01);
  var glassLen=Math.round(sr*0.5);
  var glassBuf=audioCtx.createBuffer(1,glassLen,sr);
  var gd=glassBuf.getChannelData(0);
  for(var j=0;j<glassLen;j++){
    var genv=Math.pow(1-j/glassLen,2.2);
    gd[j]=(Math.random()*2-1)*genv;
  }
  var glassSrc=audioCtx.createBufferSource();
  var glassFilt=audioCtx.createBiquadFilter(), glassGain=audioCtx.createGain();
  glassFilt.type='highpass'; glassFilt.frequency.value=5500;
  glassSrc.buffer=glassBuf;
  glassGain.gain.setValueAtTime(0.25,now+0.04);
  glassGain.gain.exponentialRampToValueAtTime(0.001,now+0.5);
  glassSrc.connect(glassFilt); glassFilt.connect(glassGain); glassGain.connect(audioCtx.destination);
  glassSrc.start(now+0.04);
}

function playAmpDestroyed(){
  if(!audioCtx)return;
  var now=audioCtx.currentTime;
  var osc1=audioCtx.createOscillator(), g1=audioCtx.createGain();
  osc1.type='square';
  osc1.frequency.setValueAtTime(880,now);
  osc1.frequency.exponentialRampToValueAtTime(40,now+0.6);
  g1.gain.setValueAtTime(0.4,now);
  g1.gain.exponentialRampToValueAtTime(0.001,now+0.6);
  osc1.connect(g1); g1.connect(audioCtx.destination);
  osc1.start(now); osc1.stop(now+0.65);
  var osc2=audioCtx.createOscillator(), g2=audioCtx.createGain();
  osc2.type='sine';
  osc2.frequency.setValueAtTime(120,now);
  osc2.frequency.exponentialRampToValueAtTime(25,now+0.25);
  g2.gain.setValueAtTime(0.7,now);
  g2.gain.exponentialRampToValueAtTime(0.001,now+0.3);
  osc2.connect(g2); g2.connect(audioCtx.destination);
  osc2.start(now); osc2.stop(now+0.35);
  var bufLen=Math.round(audioCtx.sampleRate*0.18);
  var buf=audioCtx.createBuffer(1,bufLen,audioCtx.sampleRate);
  var d=buf.getChannelData(0);
  for(var i=0;i<bufLen;i++) d[i]=(Math.random()*2-1)*(1-i/bufLen);
  var noise=audioCtx.createBufferSource(), gn=audioCtx.createGain();
  noise.buffer=buf;
  gn.gain.setValueAtTime(0.35,now);
  gn.gain.exponentialRampToValueAtTime(0.001,now+0.18);
  noise.connect(gn); gn.connect(audioCtx.destination);
  noise.start(now);
}

function startBGMusic(){var el=document.getElementById('bgAudio');if(el){el.currentTime=0;el.volume=0.45;el.play().catch(function(){});}}
function stopBGMusic(){var el=document.getElementById('bgAudio');if(el){el.pause();el.currentTime=0;}}

// ─── DRAW BACKGROUND ─────────────────────────────────────────────────────────
function drawBackground(){
  if(bgVideoReady&&!bgVideo.paused){
    ctx.drawImage(bgVideo,0,0,W,H);
    ctx.fillStyle='rgba(0,0,0,0.15)';ctx.fillRect(0,0,W,H);
  } else {
    var grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#0d0008'); grd.addColorStop(0.45,'#1a0a00'); grd.addColorStop(1,'#2a1400');
    ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='rgba(30,5,0,0.7)'; ctx.fillRect(0,CROWD_TOP,W,CROWD_BOT-CROWD_TOP);
    ctx.fillStyle='rgba(255,60,0,0.08)';
    for(var ci=0;ci<W;ci+=18){ctx.fillRect(ci,CROWD_TOP+5,12,CROWD_BOT-CROWD_TOP-10);}
    var mhc=['#ff44aa','#44ff44','#ff4400','#4466ff','#ffcc00'];
    for(var mi=0;mi<W;mi+=22){ctx.fillStyle=mhc[Math.floor(mi/22)%mhc.length];ctx.globalAlpha=0.6;ctx.beginPath();ctx.arc(mi+8,CROWD_TOP+15,4,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;}
  }
  // HUD bar
  ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(0,0,W,CROWD_TOP);
  ctx.fillStyle=C.accent; ctx.font='bold 13px "Courier New"';

  // Left: SCORE
  ctx.textAlign='left';
  ctx.fillText('SCORE: '+score, 10, 21);

  // Center: level or wave label depending on mode
  ctx.textAlign='center';
  if(gameMode==='training'){
    ctx.fillText('WAVE: '+level+'/'+MAX_LVL, W/2, 21);
  } else if(gameMode==='highscore'){
    ctx.fillStyle='#ffcc00';
    ctx.fillText('WAVE: '+level, W/2, 21);
    ctx.fillStyle=C.accent;
  } else {
    ctx.fillText('CHAOS', W/2, 21);
  }

  // Right: AMPS or AMMO depending on mode
  ctx.textAlign='right';
  var alive=amps?amps.filter(function(a){return a.alive;}).length:6;
  if(gameMode==='highscore'){
    ctx.fillStyle='#ffcc00';
    ctx.fillText('AMMO: '+ammoLeft+'  AMPS: '+alive+'/6', W-10, 21);
    ctx.fillStyle=C.accent;
  } else if(gameMode==='training'){
    ctx.fillText('AMPS: '+alive+'/6', W-10, 21);
  } else {
    ctx.fillText('AMPS: '+alive+'/6', W-10, 21);
  }
  ctx.textAlign='left';

  // Training mode: large wave enemy + ammo overlay on stage
  if(gameMode==='training' && gamePhase==='playing'){
    // Enemy count left on screen (big, semi-transparent)
    var remaining=bottles.filter(function(b){return b.alive;}).length;
    ctx.save();
    ctx.globalAlpha=0.18;
    ctx.font='bold 80px "Courier New"';
    ctx.fillStyle='#ff6600';
    ctx.textAlign='center';
    ctx.fillText(remaining, W/2, STAGE_TOP+80);
    ctx.globalAlpha=1;
    // Label below
    ctx.font='bold 11px "Courier New"';
    ctx.fillStyle='#ff6600';
    ctx.fillText('ENEMIES LEFT', W/2, STAGE_TOP+97);
    ctx.restore();
  }

  // Wooden stage planks
  for(var py=STAGE_TOP; py<STAGE_BOT; py+=14){
    var brightness=0.12+0.05*(Math.floor((py-STAGE_TOP)/14)%2);
    ctx.fillStyle='rgba(90,50,15,'+brightness+')';
    ctx.fillRect(0,py,W,13);
    ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,py+13); ctx.lineTo(W,py+13); ctx.stroke();
  }
  ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.lineWidth=0.5;
  for(var vp=0;vp<W;vp+=48){ctx.beginPath();ctx.moveTo(vp,STAGE_TOP);ctx.lineTo(vp,STAGE_BOT);ctx.stroke();}
  ctx.fillStyle='#6b3a10'; ctx.fillRect(0,STAGE_BOT,W,4);
  ctx.strokeStyle='#c87840'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(0,STAGE_BOT); ctx.lineTo(W,STAGE_BOT); ctx.stroke();
  ctx.fillStyle='#150800'; ctx.fillRect(0,STAGE_BOT+4,W,H-(STAGE_BOT+4));
}

// ─── DRAW AMP ─────────────────────────────────────────────────────────────────
function drawAmp(amp){
  var x=amp.x, y=AMP_Y;
  var dw=80, dh=54;
  var img=amp.alive?ampImg:dampImg;
  var imgReady=amp.alive?ampReady:dampReady;
  if(imgReady){
    ctx.drawImage(img, x-dw/2, y-dh+AMP_H/2, dw, dh);
  } else {
    ctx.save();
    ctx.fillStyle=amp.alive?'#100500':'#300000';
    ctx.strokeStyle=amp.alive?'#663300':'#550000';
    ctx.lineWidth=2;
    ctx.fillRect(x-AMP_W/2, y-AMP_H/2, AMP_W, AMP_H);
    ctx.strokeRect(x-AMP_W/2, y-AMP_H/2, AMP_W, AMP_H);
    if(!amp.alive){
      ctx.strokeStyle='#ff2200'; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.moveTo(x-10,y-8); ctx.lineTo(x+10,y+8); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x+10,y-8); ctx.lineTo(x-10,y+8); ctx.stroke();
    }
    ctx.restore();
  }
}

// ─── DRAW NOTE ────────────────────────────────────────────────────────────────
function drawNote(x,y,r){
  ctx.save();
  ctx.fillStyle=C.note; ctx.shadowColor=C.note; ctx.shadowBlur=8;
  ctx.beginPath(); ctx.ellipse(x,y+r*0.4,r*0.55,r*0.4,-0.4,0,Math.PI*2); ctx.fill();
  ctx.fillRect(x+r*0.2, y-r*0.7, r*0.18, r*1.1);
  ctx.beginPath(); ctx.moveTo(x+r*0.38,y-r*0.7); ctx.quadraticCurveTo(x+r,y-r*0.35,x+r*0.38,y-r*0.05); ctx.fill();
  ctx.restore();
}

// ─── DRAW PROJECTILE ─────────────────────────────────────────────────────────
function drawProjectile(x,y,type,wobble){
  ctx.save();
  ctx.translate(x,y); ctx.rotate(wobble);
  var idx=type%throwImgs.length;
  var img=throwImgs[idx];
  if(img && img.complete && img.naturalWidth>0){
    var dh=36;
    if(idx===1) dh=Math.round(36*0.80);
    else if(idx===2||idx===3||idx===4) dh=Math.round(36*1.50);
    var dw=Math.round(dh*img.naturalWidth/img.naturalHeight);
    ctx.drawImage(img, -dw/2, -dh/2, dw, dh);
  } else {
    ctx.fillStyle='#44aa44'; ctx.fillRect(-4,-16,8,18);
    ctx.fillStyle='#777'; ctx.fillRect(-2,-22,5,7);
  }
  ctx.restore();
}

// ─── GAME STATE ───────────────────────────────────────────────────────────────
var bottles,notes,explosions,amps;
var score,level,gamePhase,gameMode;
var lastSpawn,spawnInterval,spawnCount,spawnedCount;
var ammoLeft;          // highscore mode only
var waveEnemyCount;    // enemies spawned this wave (for ammo calc in highscore)

// gameMode: 'training' | 'highscore' | 'chaos'

function setLevelParams(){
  if(gameMode==='training'){
    // Fixed wave sizes per level, moderate speed
    spawnCount=3+level;
    spawnInterval=Math.max(600,1800-level*150);
  } else if(gameMode==='highscore'){
    // Endless, ramps harder and faster
    spawnCount=3+level;
    spawnInterval=Math.max(300,2000-level*180);
  } else {
    // Chaos: fast and dense, no cap
    spawnCount=4+level;
    spawnInterval=Math.max(350,1800-level*160);
  }
}

function calcWaveTotal(){
  // How many total bottles in this wave (used for ammo in highscore mode)
  // One burst every spawnInterval, up to level*3 bursts per wave
  return spawnCount*(gameMode==='training'?level*3:level*3);
}

function resetAmps(){amps=AMP_POS.map(function(x){return{x:x,alive:true};});}

function initGame(mode){
  gameMode=mode;
  score=0; level=1; bottles=[]; notes=[]; explosions=[];
  gamePhase='playing'; lastSpawn=-3000; spawnedCount=0;
  ammoLeft=0; waveEnemyCount=0;
  setLevelParams();
  resetAmps();
  if(gameMode==='highscore'){
    waveEnemyCount=spawnCount*level*3;
    ammoLeft=waveEnemyCount+3;
  }
  if(bgVideoReady) bgVideo.play().catch(function(){});
  ensureAudio(); startBGMusic();
}

var SPAWN_XS=[0,W*0.15,W*0.3,W*0.5,W*0.7,W*0.85,W];

function spawnBottle(){
  var aa=amps.filter(function(a){return a.alive;});
  if(!aa.length)return;
  var target=aa[Math.floor(Math.random()*aa.length)];
  var sx=SPAWN_XS[Math.floor(Math.random()*SPAWN_XS.length)];
  var sy=CROWD_TOP+20+Math.random()*30;
  var ty=AMP_Y;
  var angle=Math.atan2(ty-sy, target.x-sx)+Math.PI/2;
  var spd=(0.45+level*0.055)*(0.85+Math.random()*0.3);
  bottles.push({
    pos:{x:sx,y:sy}, target:target, targetY:ty,
    dx:spd*Math.sin(angle), dy:spd*-Math.cos(angle),
    alive:true, wobble:Math.random()*Math.PI*2,
    projType:Math.floor(Math.random()*throwImgs.length)
  });
}

function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

// ─── COUNTDOWN ────────────────────────────────────────────────────────────────
function showCountdown(callback){
  var overlay=document.getElementById('countdownOverlay');
  var txt=document.getElementById('countdownText');
  var steps=['1','2','3',"LET'S\nROCK"];
  var i=0;
  overlay.style.display='flex';
  function next(){
    if(i>=steps.length){overlay.style.display='none'; callback(); return;}
    var s=steps[i]; i++;
    txt.style.fontSize=(s.indexOf('\n')>=0)?'48px':'96px';
    txt.innerHTML=s.replace('\n','<br>');
    txt.style.color=(i===4)?'#c8ff00':'#ff6600';
    txt.style.textShadow=(i===4)?'0 0 40px #c8ff00':'0 0 40px #ff6600, 0 0 10px #fff';
    setTimeout(next,900);
  }
  next();
}

// ─── WAVE CLEAR (Training) ────────────────────────────────────────────────────
function showWaveClear(nextWave, callback){
  var overlay=document.getElementById('waveOverlay');
  var ct=document.getElementById('waveClearText');
  var st=document.getElementById('waveSubText');
  if(nextWave>MAX_LVL){
    ct.textContent='TRAINING COMPLETE!';
    ct.style.color='#c8ff00';
    st.textContent='YOU SURVIVED ALL 6 WAVES — FINAL SCORE: '+score;
  } else {
    ct.textContent='WAVE '+(nextWave-1)+' CLEAR!';
    ct.style.color='#c8ff00';
    st.textContent='AMPS RESTORED — WAVE '+nextWave+' INCOMING';
  }
  overlay.style.display='flex';
  setTimeout(function(){
    overlay.style.display='none';
    callback();
  }, 2000);
}

// ─── GAME LOOP ────────────────────────────────────────────────────────────────
var raf;
function gameLoop(ts){
  if(gamePhase!=='playing')return;
  raf=requestAnimationFrame(gameLoop);
  ctx.clearRect(0,0,W,H);
  drawBackground();

  // Spawn
  if(ts-lastSpawn>spawnInterval){
    for(var b=0;b<spawnCount;b++) spawnBottle();
    spawnedCount+=spawnCount; lastSpawn=ts;
  }

  // Level/wave advance logic
  var waveThreshold=spawnCount*level*3;
  if(gameMode==='training'){
    // Wave clear: all bottles gone + wave quota met
    if(bottles.length===0&&notes.length===0&&explosions.length===0
       &&spawnedCount>=waveThreshold&&ts-lastSpawn>2000){
      gamePhase='waveclear';
      cancelAnimationFrame(raf);
      var nextLvl=level+1;
      showWaveClear(nextLvl, function(){
        if(nextLvl>MAX_LVL){
          triggerGameOver(true);
        } else {
          level=nextLvl;
          spawnedCount=0; lastSpawn=ts-9999;
          setLevelParams();
          resetAmps();  // amps reset between waves in training
          gamePhase='playing';
          showCountdown(function(){
            requestAnimationFrame(gameLoop);
          });
        }
      });
      return;
    }
  } else if(gameMode==='highscore'){
    // Advance wave when quota cleared and board is empty
    if(bottles.length===0&&notes.length===0&&explosions.length===0
       &&spawnedCount>=waveThreshold&&ts-lastSpawn>2000){
      level++; spawnedCount=0; lastSpawn=ts-9999;
      setLevelParams();
      score+=500; // wave clear bonus
      waveEnemyCount=spawnCount*level*3;
      ammoLeft+=waveEnemyCount+3; // top up ammo each wave
    }
  } else {
    // Chaos: level just keeps advancing for difficulty, no wave logic
    if(bottles.length===0&&notes.length===0&&explosions.length===0
       &&spawnedCount>=waveThreshold&&ts-lastSpawn>2000){
      level++; spawnedCount=0; lastSpawn=ts-9999; setLevelParams(); score+=500;
    }
  }

  // Update projectiles
  bottles.forEach(function(btl){
    btl.pos.x+=btl.dx; btl.pos.y+=btl.dy; btl.wobble+=0.1;
    explosions.forEach(function(ex){if(dist(ex,btl.pos)<5+ex.size) btl.alive=false;});
    var d=dist(btl.pos,{x:btl.target.x,y:btl.targetY});
    if(d<6){
      btl.alive=false; btl.target.alive=false; playAmpDestroyed();
      explosions.push({x:btl.pos.x,y:btl.pos.y,size:2,dir:1,alive:true,enemy:true});
      if(!amps.some(function(a){return a.alive;})){triggerGameOver(false);return;}
    }
    if(btl.alive) drawProjectile(btl.pos.x, btl.pos.y, btl.projType, btl.wobble);
    else { playGlassBreak(); explosions.push({x:btl.pos.x,y:btl.pos.y,size:2,dir:1,alive:true,enemy:true}); }
  });

  // Update notes
  notes.forEach(function(n){
    n.pos.x+=n.dx; n.pos.y+=n.dy;
    if(dist(n.pos,n.target)<NOTE_SPD){
      n.alive=false; explosions.push({x:n.pos.x,y:n.pos.y,size:3,dir:1,alive:true,player:true});
    } else {
      ctx.save();
      var tdx=n.pos.x-n.start.x, tdy=n.pos.y-n.start.y;
      var tlen=Math.sqrt(tdx*tdx+tdy*tdy)||1;
      var tux=tdx/tlen, tuy=tdy/tlen;
      var STREAM_N=4, STREAM_GAP=20;
      for(var si=0;si<STREAM_N;si++){
        var frac=si*STREAM_GAP/tlen;
        if(frac>0.92) break;
        ctx.globalAlpha=(1-si*0.2)*0.95;
        drawNote(n.pos.x-tux*si*STREAM_GAP, n.pos.y-tuy*si*STREAM_GAP, 7-si*0.9);
      }
      ctx.restore();
    }
  });

  // Update explosions
  explosions.forEach(function(ex){
    ex.size+=0.45*ex.dir; if(ex.size>28) ex.dir=-1;
    if(ex.size<=0){ex.alive=false;return;}
    var col=ex.player?C.note:C.red;
    ctx.save(); ctx.globalAlpha=0.72; ctx.fillStyle=col; ctx.shadowColor=col; ctx.shadowBlur=18;
    ctx.beginPath(); ctx.arc(ex.x,ex.y,ex.size,0,Math.PI*2); ctx.fill();
    if(ex.enemy){
      if(smokeReady){
        var sScale=ex.size/28;
        var sDim=Math.round(80+sScale*80);
        var sAlpha=Math.max(0, 0.9-sScale*0.7);
        ctx.globalAlpha=sAlpha;
        ctx.drawImage(smokeImg, ex.x-sDim/2, ex.y-sDim/2, sDim, sDim);
      }
      ctx.fillStyle='#88cc44'; ctx.globalAlpha=0.5;
      for(var s=0;s<6;s++){var ang=(s/6)*Math.PI*2+ex.size*0.15;ctx.fillRect(ex.x+Math.cos(ang)*ex.size*1.3,ex.y+Math.sin(ang)*ex.size*1.3,3,3);}
    }
    ctx.restore();
  });

  // Draw amps
  amps.forEach(function(a){drawAmp(a);});

  // Cull
  bottles=bottles.filter(function(b){return b.alive;});
  notes=notes.filter(function(n){return n.alive;});
  explosions=explosions.filter(function(e){return e.alive;});
}

// ─── CLICK ────────────────────────────────────────────────────────────────────
canvas.addEventListener('click',function(e){
  if(gamePhase!=='playing')return;
  // High score mode: check ammo
  if(gameMode==='highscore' && ammoLeft<=0) return;
  ensureAudio();
  var rect=canvas.getBoundingClientRect();
  var mx=e.clientX-rect.left, my=e.clientY-rect.top;
  var best=null, bestD=Infinity, bestIdx=0;
  amps.forEach(function(a,i){
    if(!a.alive)return;
    var d=dist({x:mx,y:my},{x:a.x,y:AMP_Y});
    if(d<bestD){bestD=d; best=a; bestIdx=i;}
  });
  if(!best)return;
  var angle=Math.atan2(my-AMP_Y, mx-best.x)+Math.PI/2;
  notes.push({
    start:{x:best.x,y:AMP_Y}, target:{x:mx,y:my},
    pos:{x:best.x,y:AMP_Y},
    dx:NOTE_SPD*Math.sin(angle), dy:NOTE_SPD*-Math.cos(angle),
    alive:true
  });
  playGuitarSound(bestIdx);
  score+=10;
  if(gameMode==='highscore') ammoLeft--;
  // Out of ammo in highscore mode = game over
  if(gameMode==='highscore' && ammoLeft<=0 && bottles.length===0){
    // give a moment for last notes to resolve
    setTimeout(function(){
      if(gamePhase==='playing') triggerGameOver(false);
    }, 1500);
  }
});

// ─── GAME OVER ────────────────────────────────────────────────────────────────
function triggerGameOver(trainingComplete){
  if(gamePhase==='gameover')return;
  gamePhase='gameover'; cancelAnimationFrame(raf); stopBGMusic();
  var modeLabel = gameMode==='training'?'TRAINING MODE':gameMode==='highscore'?'HIGH SCORE MODE':'CHAOS MODE';
  document.getElementById('goModeLabel').textContent=modeLabel;

  var showLb=(gameMode==='highscore');
  fbGet(function(data){
    var sorted=getSorted(data);
    var scoreText = trainingComplete ? 'TRAINING COMPLETE! SCORE: '+score : 'FINAL SCORE: '+score;
    document.getElementById('goScore').textContent=scoreText;
    if(showLb && isHighScore(score,sorted) && !trainingComplete){
      var sec=document.getElementById('goInitialsSection');
      sec.style.display='flex';
      var inp=document.getElementById('goInitialsInput');
      inp.value=''; setTimeout(function(){inp.focus();},80);
      function submit(){
        if(!inp.value.trim())return;
        fbPush(inp.value.trim().toUpperCase().slice(0,3)||'AAA',score);
        sec.style.display='none';
        fbGet(function(d2){renderLb('goLb',getSorted(d2),score);});
      }
      document.getElementById('goSubmitBtn').onclick=submit;
      inp.onkeydown=function(ev){if(ev.key==='Enter') submit();};
    } else {
      document.getElementById('goInitialsSection').style.display='none';
      if(showLb) renderLb('goLb',sorted,score);
      else document.getElementById('goLb').innerHTML='';
    }
    document.getElementById('gameOverOverlay').style.display='flex';
  });
}

// ─── TITLE CARD ───────────────────────────────────────────────────────────────
(function(){
  var tc=document.getElementById('titleCard'), tctx=tc.getContext('2d');
  var tw=tc.width, th=tc.height;
  var tcImg=new Image();
  tcImg.onload=function(){
    tctx.drawImage(tcImg,0,0,tw,th);
    tctx.fillStyle='rgba(0,0,0,0.38)'; tctx.fillRect(0,0,tw,th);
    tctx.font='bold 13px "Courier New"'; tctx.textAlign='center';
    tctx.fillStyle='#ff6600'; tctx.shadowColor='#ff6600'; tctx.shadowBlur=12;
    tctx.fillText('THE BANG BOOM BAR',tw/2,th-8);
  };
  tcImg.onerror=function(){
    var bg=tctx.createLinearGradient(0,0,tw,th);
    bg.addColorStop(0,'#200800'); bg.addColorStop(1,'#3a1500');
    tctx.fillStyle=bg; tctx.fillRect(0,0,tw,th);
    tctx.font='bold 13px "Courier New"'; tctx.textAlign='center';
    tctx.fillStyle='#ff6600'; tctx.shadowColor='#ff6600'; tctx.shadowBlur=10;
    tctx.fillText('THE BANG BOOM BAR',tw/2,th-8);
  };
  tcImg.src='assets/title-card.png';
})();

// ─── INITIAL STATIC RENDER ────────────────────────────────────────────────────
score=0; level=1; amps=null; gamePhase='title'; gameMode=null; ammoLeft=0;
(function(){
  ctx.clearRect(0,0,W,H);
  var grd=ctx.createLinearGradient(0,0,0,H);
  grd.addColorStop(0,'#0d0008'); grd.addColorStop(0.45,'#1a0a00'); grd.addColorStop(1,'#2a1400');
  ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(30,5,0,0.7)'; ctx.fillRect(0,CROWD_TOP,W,CROWD_BOT-CROWD_TOP);
  for(var py2=STAGE_TOP;py2<STAGE_BOT;py2+=14){ctx.fillStyle='rgba(90,50,15,0.15)';ctx.fillRect(0,py2,W,13);}
  ctx.fillStyle='#150800'; ctx.fillRect(0,STAGE_BOT,W,H-STAGE_BOT);
})();

// ─── EVENTS ───────────────────────────────────────────────────────────────────
// Title → Mode Select
document.getElementById('titleOverlay').addEventListener('click',function(){
  ensureAudio();
  document.getElementById('titleOverlay').style.display='none';
  document.getElementById('modeSelectOverlay').style.display='flex';
});

function startMode(mode){
  document.getElementById('modeSelectOverlay').style.display='none';
  initGame(mode);
  showCountdown(function(){
    requestAnimationFrame(gameLoop);
  });
}

document.getElementById('btnTraining').addEventListener('click',function(e){e.stopPropagation();startMode('training');});
document.getElementById('btnHighscore').addEventListener('click',function(e){e.stopPropagation();startMode('highscore');});
document.getElementById('btnChaos').addEventListener('click',function(e){e.stopPropagation();startMode('chaos');});
document.getElementById('btnModeBack').addEventListener('click',function(e){
  e.stopPropagation();
  document.getElementById('modeSelectOverlay').style.display='none';
  loadTitleLb();
  document.getElementById('titleOverlay').style.display='flex';
});

document.getElementById('playAgainBtn').addEventListener('click',function(){
  document.getElementById('gameOverOverlay').style.display='none';
  var m=gameMode||'training';
  initGame(m);
  showCountdown(function(){requestAnimationFrame(gameLoop);});
});
document.getElementById('titleBtn').addEventListener('click',function(){
  document.getElementById('gameOverOverlay').style.display='none';
  loadTitleLb();
  document.getElementById('titleOverlay').style.display='flex';
  gamePhase='title'; stopBGMusic();
});
document.addEventListener('keydown',function(e){
  if(document.activeElement&&document.activeElement.tagName==='INPUT')return;
  if((e.key==='r'||e.key==='R')&&gamePhase==='gameover'){
    document.getElementById('gameOverOverlay').style.display='none';
    var m=gameMode||'training';
    initGame(m);
    showCountdown(function(){requestAnimationFrame(gameLoop);});
  }
  if((e.key==='t'||e.key==='T')&&gamePhase==='gameover'){
    document.getElementById('gameOverOverlay').style.display='none';
    loadTitleLb(); document.getElementById('titleOverlay').style.display='flex';
    gamePhase='title'; stopBGMusic();
  }
});
</script>
</body>
</html>